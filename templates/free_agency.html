{% extends 'base.html' %}

{% block title %}Free Agency{% endblock %}

{% block content %}
<style>
    .fa-container { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; }
    
    .cap-card { 
        background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; 
        position: sticky; top: 80px; height: fit-content;
    }
    
    .cap-bar-bg { background: #e5e7eb; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
    .cap-bar-fill { background: var(--accent); height: 100%; transition: width 0.3s; }
    .cap-number { font-size: 24px; font-weight: 700; color: #059669; }
    
    /* Player List Styles */
    .player-row { display: flex; align-items: center; background: #fff; padding: 15px; border-bottom: 1px solid #eee; transition: 0.1s; }
    .player-row:hover { background: #f8fafc; }
    .rating-badge { background: #333; color: #fff; padding: 3px 8px; border-radius: 4px; font-weight: 700; margin-right: 15px; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { 
        background: #fff; width: 400px; margin: 100px auto; padding: 30px; border-radius: 12px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
    }
    .agent-feedback { 
        margin-top: 15px; padding: 10px; border-radius: 6px; background: #f3f4f6; 
        font-style: italic; min-height: 40px; display: flex; align-items: center; justify-content: center;
    }
</style>

<div class="page-header">
    <h1>Free Agency</h1>
</div>

<div class="fa-container">
    <div class="card" style="padding:0; overflow:hidden;">
        <div class="card-header" style="margin:0; padding:15px; background:#f8fafc;">Available Free Agents</div>
        <div style="overflow-y:auto; max-height: 700px;">
            {% for p in free_agents %}
            <div class="player-row">
                <div class="rating-badge">{{ p.overall_rating }}</div>
                <div style="flex-grow:1;">
                    <div style="font-weight:600; font-size:16px;">{{ p.first_name }} {{ p.last_name }}</div>
                    <div style="color:#666; font-size:13px;">{{ p.position }} | Age: {{ p.age }}</div>
                </div>
                <div style="margin-right:20px; text-align:right; font-size:12px; color:#999;">
                    Est. Demand<br>
                    <span style="font-weight:600; color:#444;">${{ "{:,.1f}".format(p.asking_price/1000000) }}M</span>
                </div>
                <button onclick="openNegotiation('{{ p.player_id }}', '{{ p.last_name }}', {{ p.asking_price }})" class="btn btn-primary btn-sm">Negotiate</button>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="cap-card">
        <h3 style="margin-top:0;">Cap Space</h3>
        <div class="cap-number">${{ "{:,.1f}".format(cap_space/1000000) }}M</div>
        <div style="font-size:12px; color:#666; margin-bottom:5px;">
            Used: ${{ "{:,.1f}".format(used_cap/1000000) }}M / Cap: ${{ "{:,.1f}".format(salary_cap/1000000) }}M
        </div>
        <div class="cap-bar-bg">
            <div class="cap-bar-fill" style="width: {{ (used_cap / salary_cap * 100)|round }}%;"></div>
        </div>
        <p style="font-size:13px; color:#666; line-height:1.4;">
            Offers are deducted from cap space immediately upon acceptance. You cannot exceed the salary cap.
        </p>
    </div>
</div>

<div id="negotiationModal" class="modal">
    <div class="modal-content">
        <h2 id="modalPlayerName" style="margin-top:0;">Player Name</h2>
        <p style="color:#666; font-size:14px; margin-bottom:20px;">Make an offer to sign this player immediately.</p>
        
        <div style="margin-bottom:20px;">
            <label style="font-weight:600; display:block; margin-bottom:5px;">Annual Salary</label>
            <div style="display:flex; justify-content:center; align-items:center; gap:5px;">
                <span style="font-size:18px;">$</span>
                <input type="number" id="offerInput" placeholder="Amount (e.g. 5000000)" style="padding:10px; font-size:16px; width:150px; border-radius:6px; border:1px solid #ccc;">
            </div>
        </div>
        
        <div id="agentResponse" class="agent-feedback">
            "We are listening..."
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button onclick="submitOffer()" class="btn btn-success">Submit Offer</button>
            <button onclick="closeModal()" class="btn" style="background:#eee; color:#333;">Cancel</button>
        </div>
    </div>
</div>

<script>
    let activePlayerId = null;
    let currentCap = {{ cap_space }};

    function openNegotiation(id, name, asking) {
        activePlayerId = id;
        document.getElementById('modalPlayerName').innerText = "Sign " + name;
        document.getElementById('offerInput').value = asking; // Pre-fill with asking
        document.getElementById('agentResponse').innerText = "Agent: \"My client is looking for a fair deal.\"";
        document.getElementById('agentResponse').style.color = "#333";
        document.getElementById('negotiationModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('negotiationModal').style.display = 'none';
    }

    function submitOffer() {
        const amount = document.getElementById('offerInput').value;
        const feedback = document.getElementById('agentResponse');
        
        if (amount > currentCap) {
            feedback.innerText = "Team Error: You do not have enough Cap Space!";
            feedback.style.color = "red";
            return;
        }

        fetch('/negotiate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ player_id: activePlayerId, offer_amount: amount })
        })
        .then(res => res.json())
        .then(data => {
            feedback.innerText = "Agent: " + data.message;
            
            if(data.decision === 'accepted') {
                feedback.style.color = "green";
                feedback.style.fontWeight = "bold";
                setTimeout(() => window.location.reload(), 1500); // Refresh to update list
            } else if (data.decision === 'counter') {
                feedback.style.color = "#d97706"; // Orange
            } else {
                feedback.style.color = "red";
            }
        });
    }
</script>
{% endblock %}